#!groovy

/* A Jenkins "Declarative" Pipeline file.
See http://130.56.252.251:32779
*/

pipeline {
  
  agent {
    // special label to jenkins config. See http://130.56.252.251:32779/computer/
    label 'slave'
  }
  
  environment {
    // define environment variable active within pipeline
    CNAME = "${env.GIT_COMMIT}"
    INAME = "underworldcode/carbonite:petsc_knep@sha256:3557a63d3ced99e43953242198876388e7f3dc791e25682f5dca4089ac3208f8"
  }

  options {
    timeout(time: 2, unit: 'HOURS')
    disableConcurrentBuilds()
    timestamps()
  }

  stages {
      
    // Build stage: compile the code
    stage('Build Image') {
      steps {
        // print environment variables
        sh 'printenv'
        // build the docker
        //sh 'docker build --force-rm --no-cache -t ${INAME} -f ./Dockerfile .'
      }
    }
    
    // Test stage: runs the basic tests
 /*   stage('Basic Tests') {
      // Run inside docker continer created
      steps {
              sh '''
              docker run -i -w /home/jovyan/development --name ${CNAME} ${INAME} ./test_suite.sh
              '''
      }
      post {
        always {
              sh '''
                  docker cp ${CNAME}:/home/jovyan/development/testResults ./testResults
              '''
        }
      }
    }
    */
  }
  
  /* For post build analysis */
  post {
    failure {
      // notify users when the Pipeline fails
      emailext (
          subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
          body: "Something is wrong with ${env.BUILD_URL}",
          // mimeType: 'text/html',
          to: 'underworlddev@googlegroups.com'
        )
    }
    unstable {
      // notify users when the Pipeline fails
      emailext (
          subject: "Unstable Pipeline: ${currentBuild.fullDisplayName}",
          body: "Something is unstable with ${env.BUILD_URL}",
          // mimeType: 'text/html',
          to: 'underworlddev@googlegroups.com'
        )
    }
    success {
      script {
        if (currentBuild.previousBuild != null && currentBuild.previousBuild.result != 'SUCCESS') {
          emailext (
            subject: "Back to normal: ${currentBuild.fullDisplayName}",
            body: "Project is back to normal",
            // mimeType: 'text/html',
            to: 'underworlddev@googlegroups.com'
          )
        }
      }
    }
    cleanup {
      // force container removal
      sh 'docker rm -f ${CNAME}'
      sh 'docker rmi ${INAME}'
    }
  }
}
